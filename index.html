<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .setup-panel {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .setup-panel.hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            text-align: right;
        }

        .message.assistant {
            text-align: left;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: #f1f5f9;
            color: #2d3748;
            border-bottom-left-radius: 5px;
        }

        .input-container {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            min-height: 50px;
            padding: 0 20px;
            border-radius: 12px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .admin-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #234e52;
        }

        .status-section {
            margin-top: 10px;
            padding: 15px;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
        }

        .export-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            font-size: 12px;
            padding: 8px 16px;
        }

        .usage-indicator {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
            text-transform: uppercase;
        }

        .category-research { background: #e6fffa; color: #234e52; }
        .category-homework { background: #fff5f5; color: #742a2a; }
        .category-analysis { background: #f0fff4; color: #22543d; }
        .category-general { background: #faf5ff; color: #553c9a; }

        .server-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 10px;
        }

        .server-online { background: #c6f6d5; color: #22543d; }
        .server-offline { background: #fed7d7; color: #742a2a; }

        .backend-config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Student AI Assistant</h1>
            <p>Educational AI Helper with Database Logging</p>
            <div class="usage-indicator" id="sessionInfo">
                Session: Not Started
                <span class="server-status server-offline" id="serverStatus">Checking...</span>
            </div>
        </div>

        <div class="setup-panel" id="setupPanel">
            <div class="backend-config">
                <strong>‚öôÔ∏è Backend Configuration:</strong>
                <label for="backendUrl" style="display: block; margin-top: 8px; margin-bottom: 5px;">Backend Server URL:</label>
                <input type="text" id="backendUrl" placeholder="https://your-backend-name.onrender.com" value="" 
                       style="width: 100%; margin-bottom: 10px;">
                <small>Enter your backend service URL from Render (e.g., https://student-ai-backend-abc123.onrender.com)</small>
            </div>
            
            <div class="form-group">
                <label for="apiKey">OpenAI API Key (Required)</label>
                <input type="password" id="apiKey" placeholder="sk-...">
            </div>
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" placeholder="Enter your name">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="className">Class/Subject</label>
                    <input type="text" id="className" placeholder="e.g., Mathematics, History">
                </div>
            </div>
            <div class="form-group">
                <label for="purpose">Primary Purpose</label>
                <select id="purpose">
                    <option value="research">Research & Information Gathering</option>
                    <option value="homework">Homework Help</option>
                    <option value="analysis">Critical Analysis & Discussion</option>
                    <option value="general">General Learning Support</option>
                </select>
            </div>
            <button class="btn" onclick="startSession()">Start AI Assistant</button>
            
            <div class="admin-info">
                <strong>üìä For Educators:</strong> All interactions are permanently stored in PostgreSQL database. 
                Data persists forever and can be exported as CSV. Questions are automatically categorized and analyzed.
            </div>
        </div>

        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="messages" id="messages"></div>
            <div class="loading" id="loading">
                <span class="spinner"></span>AI is thinking...
            </div>
            <div class="input-container">
                <div class="input-row">
                    <textarea id="messageInput" class="input-field" placeholder="Ask your question here..." 
                              onkeydown="handleKeyPress(event)"></textarea>
                    <button class="btn send-btn" onclick="sendMessage()">Send</button>
                </div>
                <div class="status-section">
                    <strong>üìã Session Status:</strong>
                    <span id="csvStatus">Database logging ready</span>
                    <button class="btn export-btn" onclick="viewCSV()">View Logs</button>
                    <button class="btn export-btn" onclick="downloadCSV()">Download CSV</button>
                    <button class="btn export-btn" onclick="clearSession()">New Session</button>
                    <p style="font-size: 11px; margin-top: 5px; color: #666;">
                        Questions: <span id="questionCount">0</span> | 
                        Research: <span id="researchCount">0</span> | 
                        Potential Shortcuts: <span id="shortcutCount">0</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let API_BASE = '';
        let sessionId = null;
        let apiKey = null;
        let studentInfo = {};
        let questionCount = 0;
        let researchCount = 0;
        let shortcutCount = 0;
        let serverOnline = false;

        // Check server status on page load
        window.onload = function() {
            // Try to detect backend URL automatically
            const currentHost = window.location.hostname;
            if (currentHost.includes('onrender.com')) {
                // If we're on Render, try to guess the backend URL
                const frontendUrl = window.location.href;
                document.getElementById('backendUrl').placeholder = 'Enter your backend service URL from Render';
            }
            checkServerStatus();
        };

        async function checkServerStatus() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            
            if (!backendUrl) {
                document.getElementById('serverStatus').textContent = 'No Backend URL';
                document.getElementById('serverStatus').className = 'server-status server-offline';
                document.getElementById('csvStatus').textContent = 'Enter backend URL above';
                return;
            }

            // Remove trailing slash if present
            API_BASE = backendUrl.replace(/\/$/, '');

            try {
                const response = await fetch(`${API_BASE}/status`);
                if (response.ok) {
                    const data = await response.json();
                    serverOnline = true;
                    document.getElementById('serverStatus').textContent = 'Server Online';
                    document.getElementById('serverStatus').className = 'server-status server-online';
                    document.getElementById('csvStatus').textContent = `Database connected (${data.totalLogs || 0} logs)`;
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                serverOnline = false;
                document.getElementById('serverStatus').textContent = 'Server Offline';
                document.getElementById('serverStatus').className = 'server-status server-offline';
                document.getElementById('csvStatus').textContent = 'Cannot connect to backend server';
                console.error('Server status check failed:', error);
            }
        }

        // Check server status when backend URL changes
        document.getElementById('backendUrl').addEventListener('input', () => {
            clearTimeout(window.checkTimeout);
            window.checkTimeout = setTimeout(checkServerStatus, 1000);
        });

        function startSession() {
            const backendUrl = document.getElementById('backendUrl').value.trim();
            apiKey = document.getElementById('apiKey').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const className = document.getElementById('className').value.trim();
            const purpose = document.getElementById('purpose').value;

            if (!backendUrl) {
                alert('Please enter your backend server URL first');
                return;
            }

            if (!apiKey) {
                alert('Please enter your OpenAI API Key');
                return;
            }

            if (!serverOnline) {
                if (!confirm('Warning: Cannot connect to backend server. Continue anyway?')) {
                    return;
                }
            }

            studentInfo = {
                name: studentName || 'Anonymous',
                class: className || 'Not specified',
                purpose: purpose
            };

            sessionId = Date.now().toString();
            document.getElementById('sessionInfo').innerHTML = 
                `${studentInfo.name} | ${studentInfo.class} <span class="server-status ${serverOnline ? 'server-online' : 'server-offline'}" id="serverStatus">${serverOnline ? 'Server Online' : 'Server Offline'}</span>`;

            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('chatContainer').style.display = 'flex';

            // Log session start
            logInteraction('SESSION_START', `Student: ${studentInfo.name}, Class: ${studentInfo.class}, Purpose: ${studentInfo.purpose}`, '', 'session');

            addMessage('assistant', `Hello ${studentInfo.name}! I'm here to help with your ${studentInfo.class} studies. How can I assist you today?`);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            input.value = '';
            addMessage('user', message);

            // Analyze question type and potential academic integrity concerns
            const analysis = analyzeQuestion(message);
            
            document.getElementById('loading').classList.add('show');

            try {
                const response = await callOpenAI(message);
                addMessage('assistant', response);
                
                // Log the interaction (this will automatically save to database)
                await logInteraction('QUESTION', message, response, analysis.category, analysis);

                updateCounts(analysis);

            } catch (error) {
                addMessage('assistant', `I apologize, but I encountered an error: ${error.message}`);
                await logInteraction('ERROR', message, error.message, 'error');
            }

            document.getElementById('loading').classList.remove('show');
        }

        async function callOpenAI(message) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'system',
                            content: `You are an educational AI assistant helping a student named ${studentInfo.name} in ${studentInfo.class}. 
                                     Provide helpful, educational responses that encourage learning and critical thinking. 
                                     If asked to complete assignments directly, guide the student to understand the concepts instead.
                                     Focus on teaching and explaining rather than just providing answers.`
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ],
                    max_tokens: 1000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function analyzeQuestion(question) {
            const lowerQuestion = question.toLowerCase();
            
            // Indicators of potential academic shortcuts
            const shortcutIndicators = [
                'write my essay', 'do my homework', 'solve this problem', 'give me the answer',
                'complete this assignment', 'write a report on', 'solve for x', 'what is the answer to',
                'write a paper about', 'do this math problem', 'write code for', 'complete this code'
            ];

            // Indicators of good research/learning use
            const researchIndicators = [
                'explain', 'help me understand', 'what does this mean', 'how does', 'why does',
                'can you clarify', 'break down', 'analyze', 'compare', 'contrast', 'discuss',
                'what are the implications', 'pros and cons', 'different perspectives'
            ];

            const isShortcut = shortcutIndicators.some(indicator => 
                lowerQuestion.includes(indicator));
            
            const isResearch = researchIndicators.some(indicator => 
                lowerQuestion.includes(indicator));

            // Additional analysis
            const wordCount = question.split(' ').length;
            const hasSpecificProblem = /\d+[+\-*/=]|\b(problem \d+|question \d+|exercise \d+)\b/i.test(question);
            const isLongPaste = wordCount > 50 && question.includes('\n');
            const hasAssignmentLanguage = /assignment|homework|essay|report|project/i.test(question);

            let category = 'general';
            let flags = [];

            if (isShortcut || hasSpecificProblem) {
                category = 'homework';
                if (isShortcut) flags.push('Direct completion request');
                if (hasSpecificProblem) flags.push('Specific problem/exercise');
            } else if (isResearch) {
                category = 'research';
                flags.push('Research/learning oriented');
            } else if (lowerQuestion.includes('analyze') || lowerQuestion.includes('critical')) {
                category = 'analysis';
                flags.push('Critical thinking request');
            }

            if (isLongPaste) {
                flags.push('Long text paste - possible assignment');
            }

            if (hasAssignmentLanguage) {
                flags.push('Assignment-related language');
            }

            return {
                category,
                flags,
                wordCount,
                isShortcut,
                isResearch,
                riskLevel: isShortcut ? 'HIGH' : (hasSpecificProblem ? 'MEDIUM' : 'LOW')
            };
        }

        async function logInteraction(type, question, response, category, analysis = {}) {
            const logEntry = {
                sessionId,
                timestamp: new Date().toISOString(),
                type,
                student: studentInfo,
                question: question.substring(0, 1000),
                response: response.substring(0, 500),
                category,
                analysis,
                questionNumber: type === 'QUESTION' ? ++questionCount : null
            };

            // Send to server for logging
            if (serverOnline && API_BASE) {
                try {
                    const response = await fetch(`${API_BASE}/log`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(logEntry)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        document.getElementById('csvStatus').textContent = `Logged to database (ID: ${result.logId})`;
                    }
                } catch (error) {
                    console.warn('Failed to log to server:', error);
                    document.getElementById('csvStatus').textContent = 'Warning: Database logging failed';
                }
            }
        }

        function addMessage(sender, content) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            if (sender === 'user') {
                // Analyze and add category badge for user messages
                const analysis = analyzeQuestion(content);
                const badge = document.createElement('span');
                badge.className = `category-badge category-${analysis.category}`;
                badge.textContent = analysis.category;
                contentDiv.appendChild(badge);
            }
            
            messageDiv.appendChild(contentDiv);
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateCounts(analysis) {
            if (analysis.category === 'research') researchCount++;
            if (analysis.isShortcut) shortcutCount++;

            document.getElementById('questionCount').textContent = questionCount;
            document.getElementById('researchCount').textContent = researchCount;
            document.getElementById('shortcutCount').textContent = shortcutCount;
        }

        async function viewCSV() {
            if (serverOnline && API_BASE) {
                try {
                    const response = await fetch(`${API_BASE}/csv`);
                    const csvContent = await response.text();
                    
                    // Open CSV content in a new window
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <html>
                            <head>
                                <title>Student Interaction Log</title>
                                <style>
                                    body { font-family: monospace; padding: 20px; }
                                    pre { white-space: pre-wrap; font-size: 12px; }
                                </style>
                            </head>
                            <body>
                                <h2>Student Interaction Database Log</h2>
                                <p>Total interactions: ${csvContent.split('\\n').length - 1}</p>
                                <pre>${csvContent}</pre>
                            </body>
                        </html>
                    `);
                } catch (error) {
                    alert('Could not retrieve CSV data from server');
                }
            } else {
                alert('Server is offline or backend URL not configured.');
            }
        }

        async function downloadCSV() {
            if (serverOnline && API_BASE) {
                try {
                    const response = await fetch(`${API_BASE}/csv/download`);
                    const blob = await response.blob();
                    
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `student_interactions_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    alert('Could not download CSV file from server');
                }
            } else {
                alert('Server is offline or backend URL not configured.');
            }
        }

        function clearSession() {
            if (confirm('Start a new session? Current chat will be cleared.')) {
                document.getElementById('messages').innerHTML = '';
                questionCount = 0;
                researchCount = 0;
                shortcutCount = 0;
                updateCounts({category: 'general', isShortcut: false});
                sessionId = Date.now().toString();
                logInteraction('SESSION_START', `New session started by ${studentInfo.name}`, '', 'session');
                addMessage('assistant', `New session started! How can I help you today, ${studentInfo.name}?`);
            }
        }
    </script>
</body>
</html>
