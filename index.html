<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .setup-panel {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .setup-panel.hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            text-align: right;
        }

        .message.assistant {
            text-align: left;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: #f1f5f9;
            color: #2d3748;
            border-bottom-left-radius: 5px;
        }

        .input-container {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            min-height: 50px;
            padding: 0 20px;
            border-radius: 12px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            display: inline-block;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .admin-info {
            background: #e6fffa;
            border: 1px solid #81e6d9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #234e52;
        }

        .status-section {
            margin-top: 10px;
            padding: 15px;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
        }

        .export-btn {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            font-size: 12px;
            padding: 8px 16px;
        }

        .usage-indicator {
            position: absolute;
            top: 10px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
            text-transform: uppercase;
        }

        .category-research { background: #e6fffa; color: #234e52; }
        .category-homework { background: #fff5f5; color: #742a2a; }
        .category-analysis { background: #f0fff4; color: #22543d; }
        .category-general { background: #faf5ff; color: #553c9a; }
        .category-off-topic { background: #fed7d7; color: #742a2a; }

        .server-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 10px;
        }

        .server-online { background: #c6f6d5; color: #22543d; }
        .server-offline { background: #fed7d7; color: #742a2a; }

        .teacher-guidelines {
            background: #fff8dc;
            border: 1px solid #f4d03f;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-size: 12px;
            color: #7d6608;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 AI Teaching Assistant</h1>
            <p>Your Educational Guide - Helping You Learn, Not Giving Answers</p>
            <div class="usage-indicator" id="sessionInfo">
                Session: Not Started
                <span class="server-status server-offline" id="serverStatus">Connecting...</span>
            </div>
        </div>

        <div class="setup-panel" id="setupPanel">
            <div class="form-group">
                <label for="apiKey">OpenAI API Key (Required)</label>
                <input type="password" id="apiKey" placeholder="sk-...">
                <small style="color: #666; font-size: 11px;">Your API key is stored securely and only used for this session</small>
            </div>
            <div style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" placeholder="Enter your name">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="className">Subject/Class</label>
                    <input type="text" id="className" placeholder="e.g., Algebra, Biology, History">
                </div>
            </div>
            <div class="form-group">
                <label for="gradeLevel">Grade Level</label>
                <select id="gradeLevel">
                    <option value="elementary">Elementary School (K-5)</option>
                    <option value="middle">Middle School (6-8)</option>
                    <option value="high" selected>High School (9-12)</option>
                    <option value="college">College/University</option>
                </select>
            </div>
            <button class="btn" onclick="startSession()">Start Learning Session</button>
            
            <div class="teacher-guidelines">
                <strong>🍎 Teaching Philosophy:</strong> I'm designed to guide your learning journey, not provide direct answers. 
                I'll ask questions, provide hints, and help you think through problems step-by-step. This builds real understanding!
            </div>
            
            <div class="admin-info">
                <strong>📊 For Educators:</strong> All interactions are permanently logged with academic integrity analysis. 
                The AI refuses non-academic questions and promotes genuine learning through guided discovery.
            </div>
        </div>

        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="messages" id="messages"></div>
            <div class="loading" id="loading">
                <span class="spinner"></span>Thinking of the best way to guide you...
            </div>
            <div class="input-container">
                <div class="input-row">
                    <textarea id="messageInput" class="input-field" placeholder="Ask me about your schoolwork - I'll guide you to the answer!" 
                              onkeydown="handleKeyPress(event)"></textarea>
                    <button class="btn send-btn" onclick="sendMessage()">Ask</button>
                </div>
                <div class="status-section">
                    <strong>📋 Learning Progress:</strong>
                    <span id="csvStatus">Session tracking active</span>
                    <button class="btn export-btn" onclick="viewCSV()">View Logs</button>
                    <button class="btn export-btn" onclick="downloadCSV()">Download Data</button>
                    <button class="btn export-btn" onclick="clearSession()">New Session</button>
                    <p style="font-size: 11px; margin-top: 5px; color: #666;">
                        Questions Asked: <span id="questionCount">0</span> | 
                        Learning Questions: <span id="researchCount">0</span> | 
                        Answer-Seeking: <span id="shortcutCount">0</span> |
                        Off-Topic: <span id="offTopicCount">0</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fixed backend URL - no need for user input
        const API_BASE = 'https://student-ai-backend-ek8u.onrender.com';
        
        let sessionId = null;
        let apiKey = null;
        let studentInfo = {};
        let questionCount = 0;
        let researchCount = 0;
        let shortcutCount = 0;
        let offTopicCount = 0;
        let serverOnline = false;

        // Check server status on page load
        window.onload = function() {
            checkServerStatus();
        };

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                if (response.ok) {
                    const data = await response.json();
                    serverOnline = true;
                    document.getElementById('serverStatus').textContent = 'Connected';
                    document.getElementById('serverStatus').className = 'server-status server-online';
                    document.getElementById('csvStatus').textContent = `Database connected (${data.totalLogs || 0} total interactions)`;
                } else {
                    throw new Error('Server not responding');
                }
            } catch (error) {
                serverOnline = false;
                document.getElementById('serverStatus').textContent = 'Offline';
                document.getElementById('serverStatus').className = 'server-status server-offline';
                document.getElementById('csvStatus').textContent = 'Backend server unavailable';
                console.error('Server status check failed:', error);
            }
        }

        function startSession() {
            apiKey = document.getElementById('apiKey').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const className = document.getElementById('className').value.trim();
            const gradeLevel = document.getElementById('gradeLevel').value;

            if (!apiKey) {
                alert('Please enter your OpenAI API Key to start learning!');
                return;
            }

            if (!serverOnline) {
                if (!confirm('Warning: Backend server is offline. Learning session data will not be saved. Continue?')) {
                    return;
                }
            }

            studentInfo = {
                name: studentName || 'Anonymous Student',
                class: className || 'General Studies',
                gradeLevel: gradeLevel
            };

            sessionId = Date.now().toString();
            document.getElementById('sessionInfo').innerHTML = 
                `${studentInfo.name} | ${studentInfo.class} <span class="server-status ${serverOnline ? 'server-online' : 'server-offline'}" id="serverStatus">${serverOnline ? 'Connected' : 'Offline'}</span>`;

            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('chatContainer').style.display = 'flex';

            // Log session start
            logInteraction('SESSION_START', `Student: ${studentInfo.name}, Subject: ${studentInfo.class}, Grade: ${studentInfo.gradeLevel}`, '', 'session');

            const welcomeMessage = getWelcomeMessage();
            addMessage('assistant', welcomeMessage);
        }

        function getWelcomeMessage() {
            const gradeLevel = studentInfo.gradeLevel;
            const subject = studentInfo.class;
            
            let welcomeMsg = `Hello ${studentInfo.name}! I'm your AI teaching assistant. `;
            
            if (gradeLevel === 'elementary') {
                welcomeMsg += `I'm here to help you explore and discover answers in ${subject}! Instead of telling you the answer, I'll ask questions that help you figure things out yourself. What would you like to learn about today?`;
            } else if (gradeLevel === 'middle') {
                welcomeMsg += `I'm here to guide your learning in ${subject}. I won't give you direct answers, but I'll help you think through problems step-by-step. What topic are you working on?`;
            } else if (gradeLevel === 'high') {
                welcomeMsg += `I'm here to facilitate your learning in ${subject}. My role is to guide you to discover answers through questions and hints, building your critical thinking skills. What concept would you like to explore?`;
            } else {
                welcomeMsg += `I'm here to support your academic journey in ${subject}. I'll use the Socratic method to help you develop deep understanding rather than providing direct answers. What topic are you studying?`;
            }
            
            return welcomeMsg;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            input.value = '';
            addMessage('user', message);

            // Analyze question type and content
            const analysis = analyzeQuestion(message);
            
            document.getElementById('loading').classList.add('show');

            try {
                const response = await callOpenAI(message, analysis);
                addMessage('assistant', response);
                
                // Log the interaction
                await logInteraction('QUESTION', message, response, analysis.category, analysis);

                updateCounts(analysis);

            } catch (error) {
                addMessage('assistant', `I apologize, but I encountered an error: ${error.message}. Please try asking your question again.`);
                await logInteraction('ERROR', message, error.message, 'error');
            }

            document.getElementById('loading').classList.remove('show');
        }

        async function callOpenAI(message, analysis) {
            // Enhanced system prompt for teacher-like behavior
            const systemPrompt = `You are an AI teaching assistant for ${studentInfo.name}, a ${studentInfo.gradeLevel} student studying ${studentInfo.class}. Your core principles:

TEACHING PHILOSOPHY:
- NEVER give direct answers to homework problems or assignments
- Use the Socratic method: guide learning through questions
- Help students think critically and discover answers themselves
- Encourage understanding over memorization

RESPONSE RULES:
1. If asked to solve homework directly: Politely decline and offer to guide them through the thinking process
2. If asked about non-academic topics: Redirect to educational content related to their subject
3. If student seems frustrated: Acknowledge their feelings and break the problem into smaller steps
4. Always ask follow-up questions to check understanding

RESPONSE STYLE:
- Be encouraging and patient
- Use age-appropriate language for ${studentInfo.gradeLevel} level
- Provide hints, not answers
- Ask "What do you think?" or "What's your reasoning?"
- Celebrate thinking process, not just correct answers

ACADEMIC INTEGRITY:
- Flag if student is trying to get you to do their work
- Promote genuine learning and understanding
- Guide them to reliable sources for research

Current question analysis: ${JSON.stringify(analysis)}

If the question is off-topic (not related to education), politely redirect them to ask about their ${studentInfo.class} studies instead.`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'system',
                            content: systemPrompt
                        },
                        {
                            role: 'user',
                            content: message
                        }
                    ],
                    max_tokens: 800,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'API request failed');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function analyzeQuestion(question) {
            const lowerQuestion = question.toLowerCase();
            
            // Academic subjects and keywords
            const academicKeywords = [
                'math', 'science', 'history', 'english', 'literature', 'chemistry', 'physics', 'biology',
                'algebra', 'geometry', 'calculus', 'essay', 'homework', 'assignment', 'study', 'learn',
                'understand', 'explain', 'analyze', 'compare', 'research', 'write', 'solve', 'calculate',
                'grammar', 'vocabulary', 'reading', 'writing', 'geography', 'government', 'economics'
            ];

            // Direct answer seeking indicators
            const shortcutIndicators = [
                'give me the answer', 'what is the answer', 'solve this', 'do my homework',
                'write my essay', 'complete this', 'tell me the solution', 'just tell me',
                'what\'s the answer to', 'solve for x', 'write a report on', 'do this problem'
            ];

            // Learning-oriented indicators
            const learningIndicators = [
                'help me understand', 'explain', 'how do', 'why does', 'what does this mean',
                'can you guide me', 'help me think', 'walk me through', 'break down',
                'what should I consider', 'how should I approach', 'what are the steps'
            ];

            // Non-academic topics
            const offTopicIndicators = [
                'what\'s the weather', 'tell me a joke', 'what time is it', 'how are you',
                'what can you do', 'who made you', 'favorite movie', 'sports', 'games',
                'entertainment', 'celebrity', 'politics', 'gossip', 'social media'
            ];

            const isAcademic = academicKeywords.some(keyword => lowerQuestion.includes(keyword));
            const isShortcut = shortcutIndicators.some(indicator => lowerQuestion.includes(indicator));
            const isLearning = learningIndicators.some(indicator => lowerQuestion.includes(indicator));
            const isOffTopic = offTopicIndicators.some(indicator => lowerQuestion.includes(indicator)) || !isAcademic;

            const wordCount = question.split(' ').length;
            const hasSpecificProblem = /\d+[+\-*/=]|\b(problem \d+|question \d+|exercise \d+)\b/i.test(question);
            const isLongPaste = wordCount > 50 && question.includes('\n');

            let category = 'general';
            let flags = [];

            if (isOffTopic && !isAcademic) {
                category = 'off-topic';
                flags.push('Non-academic question');
            } else if (isShortcut) {
                category = 'homework';
                flags.push('Direct answer seeking');
                if (hasSpecificProblem) flags.push('Specific problem/exercise');
            } else if (isLearning) {
                category = 'research';
                flags.push('Learning-oriented inquiry');
            } else if (lowerQuestion.includes('analyze') || lowerQuestion.includes('critical')) {
                category = 'analysis';
                flags.push('Critical thinking request');
            }

            if (isLongPaste) {
                flags.push('Long text paste - possible assignment');
            }

            return {
                category,
                flags,
                wordCount,
                isShortcut,
                isLearning,
                isOffTopic,
                riskLevel: isShortcut ? 'HIGH' : (hasSpecificProblem ? 'MEDIUM' : 'LOW')
            };
        }

        async function logInteraction(type, question, response, category, analysis = {}) {
            const logEntry = {
                sessionId,
                timestamp: new Date().toISOString(),
                type,
                student: studentInfo,
                question: question.substring(0, 1000),
                response: response.substring(0, 500),
                category,
                analysis,
                questionNumber: type === 'QUESTION' ? ++questionCount : null
            };

            if (serverOnline) {
                try {
                    const response = await fetch(`${API_BASE}/log`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(logEntry)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        document.getElementById('csvStatus').textContent = `Logged to database (ID: ${result.logId})`;
                    }
                } catch (error) {
                    console.warn('Failed to log to server:', error);
                    document.getElementById('csvStatus').textContent = 'Warning: Logging failed';
                }
            }
        }

        function addMessage(sender, content) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            if (sender === 'user') {
                const analysis = analyzeQuestion(content);
                const badge = document.createElement('span');
                badge.className = `category-badge category-${analysis.category}`;
                badge.textContent = analysis.category;
                contentDiv.appendChild(badge);
            }
            
            messageDiv.appendChild(contentDiv);
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function updateCounts(analysis) {
            if (analysis.category === 'research') researchCount++;
            if (analysis.isShortcut) shortcutCount++;
            if (analysis.isOffTopic) offTopicCount++;

            document.getElementById('questionCount').textContent = questionCount;
            document.getElementById('researchCount').textContent = researchCount;
            document.getElementById('shortcutCount').textContent = shortcutCount;
            document.getElementById('offTopicCount').textContent = offTopicCount;
        }

        async function viewCSV() {
            if (serverOnline) {
                try {
                    const response = await fetch(`${API_BASE}/csv`);
                    const csvContent = await response.text();
                    
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(`
                        <html>
                            <head>
                                <title>Student Learning Analytics</title>
                                <style>
                                    body { font-family: monospace; padding: 20px; }
                                    pre { white-space: pre-wrap; font-size: 12px; }
                                    .header { font-family: sans-serif; margin-bottom: 20px; }
                                </style>
                            </head>
                            <body>
                                <div class="header">
                                    <h2>Student Learning Analytics Dashboard</h2>
                                    <p>Total interactions: ${csvContent.split('\\n').length - 1}</p>
                                    <p>Generated: ${new Date().toLocaleString()}</p>
                                </div>
                                <pre>${csvContent}</pre>
                            </body>
                        </html>
                    `);
                } catch (error) {
                    alert('Could not retrieve analytics data from server');
                }
            } else {
                alert('Server is offline. Cannot view analytics.');
            }
        }

        async function downloadCSV() {
            if (serverOnline) {
                try {
                    const response = await fetch(`${API_BASE}/csv/download`);
                    const blob = await response.blob();
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `student_learning_analytics_${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    alert('Could not download analytics file from server');
                }
            } else {
                alert('Server is offline. Cannot download analytics.');
            }
        }

        function clearSession() {
            if (confirm('Start a new learning session? Current conversation will be cleared.')) {
                document.getElementById('messages').innerHTML = '';
                questionCount = 0;
                researchCount = 0;
                shortcutCount = 0;
                offTopicCount = 0;
                updateCounts({category: 'general', isShortcut: false, isOffTopic: false});
                sessionId = Date.now().toString();
                logInteraction('SESSION_START', `New session started by ${studentInfo.name}`, '', 'session');
                
                const welcomeMessage = getWelcomeMessage();
                addMessage('assistant', welcomeMessage);
            }
        }
    </script>
</body>
</html>
